cat("\014") # Clear your console
rm(list = ls()) #clear your environment

########################## Load in header file ######################## #
setwd("~/git/of_dollars_and_data")
source(file.path(paste0(getwd(),"/header.R")))

########################## Load in Libraries ########################## #

library(dplyr)
library(tidyr)
library(scales)
library(ggplot2)
library(grid)
library(gridExtra)
library(gtable)
library(ggrepel)
library(stringr)

folder_name <- "_jkb/0005_human_capital_plots"
out_path <- paste0(exportdir, folder_name)
dir.create(file.path(paste0(out_path)), showWarnings = FALSE)

########################## Start Program Here ######################### #

bw_colors <- c("#969696", "#000000")

n_years_working           <- 40
starting_income           <- 50000
discount_rate             <- 0.03
savings_rate              <- 0.15
annual_return             <- 0.06
growth_rate               <- 0.0
starting_financial_assets <- 0

assets <- data.frame(matrix(NA, nrow = n_years_working+1, ncol = 0))

for (i in 1:(n_years_working+1)){
  if (i == 1){
    assets[i, "financial_assets"] <- starting_financial_assets
    assets[i, "human_capital"]    <- sum(starting_income * (1+growth_rate)^(seq(1, n_years_working)) / ((1 + discount_rate)^(seq(1, n_years_working))))
  } else if (i == (n_years_working+1)){
    assets[i, "financial_assets"] <- starting_income*(1+growth_rate)^(n_years_working+1) * savings_rate + (assets[(i-1), "financial_assets"] * (1 + annual_return))
    assets[i, "human_capital"]    <- 0
  } else if (i > 1){
    assets[i, "financial_assets"] <- starting_income*(1+growth_rate)^(i) * savings_rate + (assets[(i-1), "financial_assets"] * (1 + annual_return))
    assets[i, "human_capital"]    <- sum(starting_income * (1+growth_rate)^(seq(1, n_years_working-i+1)) / ((1 + discount_rate)^(seq(1, n_years_working-i+1))))
  }
    assets[i, "year"]            <- (i-1)
    assets[i, "alpha_financial"] <- (1/n_years_working)*i + 0.1
    assets[i, "alpha_human"]     <- 1 - (1/n_years_working)*i + 0.1
}

# Convert wide to long so I can plot both the financial assets and human capital side by side
assets_long <- gather(assets, 
                      `financial_assets`, 
                      `human_capital`, 
                      key = "asset_type", 
                      value = "value")

# Convert the alphas into their own columns afterwards as well
# Make sure to keep only the relevant pairings
to_plot <- gather(assets_long, 
                      `alpha_financial`, 
                      `alpha_human`, 
                      key = "alpha_type", 
                      value = "alpha") %>%
                filter((asset_type == "financial_assets" & alpha_type == "alpha_financial") | 
                        (asset_type == "human_capital" & alpha_type == "alpha_human"))

# Function to find a rounded max/min based on the specifications of y_unit
create_max_min <- function(x, unit, ceilfloor) {
  ceilfloor(x/unit)*unit
}

# Set the y_max dynamically
y_max <- create_max_min(max(assets_long$value), 100000, ceiling)

# Find the maximum financial asset value
fin_max <- max(filter(assets_long, asset_type == "financial_assets")$value)

# Set the file path
file_path = paste0(out_path, "/human_capital_lifetime_plot.jpeg")

# Create plot
plot <- ggplot(data = to_plot, aes(x = year, y = value, fill = asset_type)) +
          geom_bar(stat = "identity", position = "dodge") +
          geom_text_repel(data = filter(assets_long, 
                                        year == 3, 
                                        asset_type == "human_capital"),
            aes(x = year, 
                y= value,
                col = asset_type,
                label = str_wrap("Present Value of Human Capital", width = 18),
                family = "my_font"),
            segment.colour = "transparent",
            nudge_x = 12) +
          geom_text_repel(data = filter(assets_long, 
                                year == (n_years_working-8), 
                                asset_type == "financial_assets"),
                  aes(x = year, 
                      y= value,
                      col = asset_type,
                      label = "Financial Assets",
                      family = "my_font"),
                  segment.colour = "transparent",
                  nudge_y = y_max/2.75) +
          scale_fill_manual(values = bw_colors, guide = FALSE) +
          scale_colour_manual(values = bw_colors, guide = FALSE) +
          scale_y_continuous(label = dollar, breaks = seq(0, y_max, 200000), limits = c(0, y_max)) +
          of_dollars_and_data_theme +
          labs(x = "Years" , y = "Value") +
          ggtitle(paste0("As You Age, Your Financial Assets\nShould Replace Your Human Capital"))
  
  # Save the gtable
  ggsave(file_path, plot, width = 15, height = 12, units = "cm")
  

# ############################  End  ################################## #